import streamlit as st
import json
import time
from datetime import datetime
from ai_engine import analyze_state
from utils import get_status_color, load_sensor_data

st.set_page_config(page_title="Alus Simulaattori", layout="wide")
st.title("ğŸš¢ Alus Simulaattori")

# Ladataan sensordata
data = load_sensor_data("data/sensors.json")  # LisÃ¤Ã¤ tiedostopolku

# Sidebar ohjaus
st.sidebar.header("âš™ï¸ Ohjauspaneeli")
manual_update = st.sidebar.checkbox("PÃ¤ivitÃ¤ tila manuaalisesti")

# Manuali-tilan toiminnot
if manual_update:
    st.sidebar.subheader("SÃ¤Ã¤dÃ¤ komponentteja")

    # SÃ¤Ã¤dÃ¤ moottorin lÃ¤mpÃ¶tila ja Ã¶ljyn mÃ¤Ã¤rÃ¤
    engine_temp = st.sidebar.slider("PÃ¤Ã¤moottori LÃ¤mpÃ¶tila (Â°C)", min_value=0, max_value=100, value=data['engine']['temp'])
    engine_oil = st.sidebar.slider("PÃ¤Ã¤moottori Ã–ljyn mÃ¤Ã¤rÃ¤ (%)", min_value=0, max_value=100, value=data['engine']['oil_level'])

    # SÃ¤Ã¤dÃ¤ apumoottorin lÃ¤mpÃ¶tila ja Ã¶ljyn mÃ¤Ã¤rÃ¤
    aux_engine_temp = st.sidebar.slider("Apumoottori LÃ¤mpÃ¶tila (Â°C)", min_value=0, max_value=100, value=data['aux_engine']['temp'])
    aux_engine_oil = st.sidebar.slider("Apumoottori Ã–ljyn mÃ¤Ã¤rÃ¤ (%)", min_value=0, max_value=100, value=data['aux_engine']['oil_level'])

    # SÃ¤Ã¤dÃ¤ pumpun lÃ¤mpÃ¶tila
    pump_temp = st.sidebar.slider("Pumppu LÃ¤mpÃ¶tila (Â°C)", min_value=0, max_value=100, value=data['pump']['temp'])

    # PÃ¤ivitÃ¤ arvot
    if st.sidebar.button("ğŸ” PÃ¤ivitÃ¤ tila nyt"):
        data['engine']['temp'] = engine_temp
        data['engine']['oil_level'] = engine_oil
        data['aux_engine']['temp'] = aux_engine_temp
        data['aux_engine']['oil_level'] = aux_engine_oil
        data['pump']['temp'] = pump_temp
else:
    time.sleep(1)
    data = load_sensor_data("data/sensors.json")  # PÃ¤ivitÃ¤ automaattisesti joka sekunti

# PÃ¤Ã¤paneeli
st.subheader("ğŸ“Š Komponenttien tila")

cols = st.columns(3)

# PÃ¤Ã¤moottori
with cols[0]:
    st.markdown(f"### ğŸ› ï¸ PÃ¤Ã¤moottori")
    st.metric("LÃ¤mpÃ¶tila", f"{data['engine']['temp']} Â°C")
    st.metric("Ã–ljyn mÃ¤Ã¤rÃ¤", f"{data['engine']['oil_level']} %")
    st.metric("Toiminta", data['engine']['status'])
    st.markdown(f"**Tila:** <span sty-le='color:{get_status_color(data['engine']['status'])}'>{data['engine']['status']}</span>", unsafe_allow_html=True)

# Apumoottori
with cols[1]:
    st.markdown(f"### ğŸ”§ Apumoottori")
    st.metric("LÃ¤mpÃ¶tila", f"{data['aux_engine']['temp']} Â°C")
    st.metric("Ã–ljyn mÃ¤Ã¤rÃ¤", f"{data['aux_engine']['oil_level']} %")
    st.metric("Toiminta", data['aux_engine']['status'])
    st.markdown(f"**Tila:** <span sty-le='color:{get_status_color(data['aux_engine']['status'])}'>{data['aux_engine']['status']}</span>", unsafe_allow_html=True)

# Pumppu
with cols[2]:
    st.markdown(f"### ğŸ’§ Pumppu")
    st.metric("Toiminta", data['pump']['status'])
    if data['pump']['status'] == "KÃ¤ynnissÃ¤":
        st.metric("LÃ¤mpÃ¶tila", f"{data['pump']['temp']} Â°C")
    st.markdown(f"**Tila:** <span sty-le='color:{get_status_color(data['pump']['status'])}'>{data['pump']['status']}</span>", unsafe_allow_html=True)

# Sensorihistoria ja tekoÃ¤lyn ehdotukset
st.subheader("ğŸ§  TekoÃ¤lyn analyysi ja historiat")
ai_response = analyze_state(data)
st.info(f"TekoÃ¤lyn ehdotus: {ai_response['advice']}")

st.markdown("### ğŸ“œ Tila-historia ja korjaustoimet")
for event in reversed(data['history'][-5:]):
    st.markdown(f"- [{event['timestamp']}] **{event['component']}**: {event['status']} â€” {event.get('fix', 'Ei toimenpiteitÃ¤')}")  

# Keskustelu tekoÃ¤lyn kanssa
st.subheader("ğŸ—£ï¸ Keskustele tekoÃ¤lyn kanssa")

# KÃ¤yttÃ¤jÃ¤ syÃ¶ttÃ¤Ã¤ kysymyksensÃ¤
user_input = st.text_input("Kysy tekoÃ¤lyltÃ¤:")

if user_input:
    # Analysoi syÃ¶te tekoÃ¤lylle
    ai_response = analyze_state(data, user_input)  # Oletetaan, ettÃ¤ analysoin-tifunktio voi ottaa kÃ¤yttÃ¤jÃ¤n syÃ¶tteen
    st.write(f"TekoÃ¤ly vastaa: {ai_response['response']}")  # TekoÃ¤lyn vastaus
